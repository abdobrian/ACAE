<!DOCTYPE html>
<html>
<head>
  <title>main.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "ClientApp\\node_modules\\domain-task\\main.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>main.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;
<span class="hljs-built_in">Object</span>.defineProperty(exports, <span class="hljs-string">"__esModule"</span>, { <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> });
<span class="hljs-keyword">var</span> domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">"domain"</span>);
<span class="hljs-keyword">var</span> domainContext = <span class="hljs-built_in">require</span>(<span class="hljs-string">"domain-context"</span>);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Not using symbols, because this may need to run in a version of Node.js that doesn't support them</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> domainTasksStateKey = <span class="hljs-string">'__DOMAIN_TASKS'</span>;
<span class="hljs-keyword">var</span> domainTaskBaseUrlStateKey = <span class="hljs-string">'__DOMAIN_TASK_INTERNAL_FETCH_BASEURL__DO_NOT_REFERENCE_THIS__'</span>;
<span class="hljs-keyword">var</span> noDomainBaseUrl;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addTask</span>(<span class="hljs-params">task</span>) </span>{
    <span class="hljs-keyword">if</span> (task &amp;&amp; domain.active) {
        <span class="hljs-keyword">var</span> state_1 = domainContext.get(domainTasksStateKey);
        <span class="hljs-keyword">if</span> (state_1) {
            state_1.numRemainingTasks++;
            task.then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>The application may have other listeners chained to this promise <em>after</em>
this listener, which may in turn register further tasks. Since we don't
want the combined task to complete until all the handlers for child tasks
have finished, delay the response to give time for more tasks to be added
synchronously.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                    state_1.numRemainingTasks--;
                    <span class="hljs-keyword">if</span> (state_1.numRemainingTasks === <span class="hljs-number">0</span> &amp;&amp; !state_1.hasIssuedSuccessCallback) {
                        state_1.hasIssuedSuccessCallback = <span class="hljs-literal">true</span>;
                        setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                            state_1.completionCallback(<span class="hljs-comment">/* error */</span> <span class="hljs-literal">null</span>);
                        }, <span class="hljs-number">0</span>);
                    }
                }, <span class="hljs-number">0</span>);
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                state_1.completionCallback(error);
            });
        }
    }
}
exports.addTask = addTask;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">codeToRun, completionCallback</span>) </span>{
    <span class="hljs-keyword">var</span> synchronousResult;
    domainContext.runInNewDomain(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> state = {
            <span class="hljs-attr">numRemainingTasks</span>: <span class="hljs-number">0</span>,
            <span class="hljs-attr">hasIssuedSuccessCallback</span>: <span class="hljs-literal">false</span>,
            <span class="hljs-attr">completionCallback</span>: domain.active.bind(completionCallback)
        };
        <span class="hljs-keyword">try</span> {
            domainContext.set(domainTasksStateKey, state);
            synchronousResult = codeToRun();
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>If no tasks were registered synchronously, then we're done already</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (state.numRemainingTasks === <span class="hljs-number">0</span> &amp;&amp; !state.hasIssuedSuccessCallback) {
                state.hasIssuedSuccessCallback = <span class="hljs-literal">true</span>;
                setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
                    state.completionCallback(<span class="hljs-comment">/* error */</span> <span class="hljs-literal">null</span>);
                }, <span class="hljs-number">0</span>);
            }
        }
        <span class="hljs-keyword">catch</span> (ex) {
            state.completionCallback(ex);
        }
    });
    <span class="hljs-keyword">return</span> synchronousResult;
}
exports.run = run;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">baseUrl</span>(<span class="hljs-params">url</span>) </span>{
    <span class="hljs-keyword">if</span> (url) {
        <span class="hljs-keyword">if</span> (domain.active) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>There's an active domain (e.g., in Node.js), so associate the base URL with it</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            domainContext.set(domainTaskBaseUrlStateKey, url);
        }
        <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>There's no active domain (e.g., in browser), so there's just one shared base URL</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            noDomainBaseUrl = url;
        }
    }
    <span class="hljs-keyword">return</span> domain.active ? domainContext.get(domainTaskBaseUrlStateKey) : noDomainBaseUrl;
}
exports.baseUrl = baseUrl;

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
