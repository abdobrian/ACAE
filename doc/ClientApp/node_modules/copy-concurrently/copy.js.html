<!DOCTYPE html>
<html>
<head>
  <title>copy.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "ClientApp\\node_modules\\copy-concurrently\\copy.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>copy.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>
<span class="hljs-built_in">module</span>.exports = copy
<span class="hljs-built_in">module</span>.exports.item = copyItem
<span class="hljs-built_in">module</span>.exports.recurse = recurseDir
<span class="hljs-built_in">module</span>.exports.symlink = copySymlink
<span class="hljs-built_in">module</span>.exports.file = copyFile

<span class="hljs-keyword">var</span> nodeFs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>)
<span class="hljs-keyword">var</span> path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>)
<span class="hljs-keyword">var</span> validate = <span class="hljs-built_in">require</span>(<span class="hljs-string">'aproba'</span>)
<span class="hljs-keyword">var</span> stockWriteStreamAtomic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs-write-stream-atomic'</span>)
<span class="hljs-keyword">var</span> mkdirp = <span class="hljs-built_in">require</span>(<span class="hljs-string">'mkdirp'</span>)
<span class="hljs-keyword">var</span> rimraf = <span class="hljs-built_in">require</span>(<span class="hljs-string">'rimraf'</span>)
<span class="hljs-keyword">var</span> isWindows = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./is-windows'</span>)
<span class="hljs-keyword">var</span> RunQueue = <span class="hljs-built_in">require</span>(<span class="hljs-string">'run-queue'</span>)
<span class="hljs-keyword">var</span> extend = <span class="hljs-built_in">Object</span>.assign || <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)._extend

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">promisify</span> (<span class="hljs-params">Promise, fn</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> args = [].slice.call(<span class="hljs-built_in">arguments</span>)
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
      <span class="hljs-keyword">return</span> fn.apply(<span class="hljs-literal">null</span>, args.concat(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err, value</span>) </span>{
        <span class="hljs-keyword">if</span> (err) {
          reject(err)
        } <span class="hljs-keyword">else</span> {
          resolve(value)
        }
      }))
    })
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copy</span> (<span class="hljs-params">from, to, opts</span>) </span>{
  validate(<span class="hljs-string">'SSO|SS'</span>, <span class="hljs-built_in">arguments</span>)
  opts = extend({}, opts || {})

  <span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = opts.Promise || global.Promise
  <span class="hljs-keyword">var</span> fs = opts.fs || nodeFs

  <span class="hljs-keyword">if</span> (opts.isWindows == <span class="hljs-literal">null</span>) opts.isWindows = isWindows
  <span class="hljs-keyword">if</span> (!opts.Promise) opts.Promise = <span class="hljs-built_in">Promise</span>
  <span class="hljs-keyword">if</span> (!opts.fs) opts.fs = fs
  <span class="hljs-keyword">if</span> (!opts.recurseWith) opts.recurseWith = copyItem
  <span class="hljs-keyword">if</span> (!opts.lstat) opts.lstat = promisify(opts.Promise, fs.lstat)
  <span class="hljs-keyword">if</span> (!opts.stat) opts.stat = promisify(opts.Promise, fs.stat)
  <span class="hljs-keyword">if</span> (!opts.chown) opts.chown = promisify(opts.Promise, fs.chown)
  <span class="hljs-keyword">if</span> (!opts.readdir) opts.readdir = promisify(opts.Promise, fs.readdir)
  <span class="hljs-keyword">if</span> (!opts.readlink) opts.readlink = promisify(opts.Promise, fs.readlink)
  <span class="hljs-keyword">if</span> (!opts.symlink) opts.symlink = promisify(opts.Promise, fs.symlink)
  <span class="hljs-keyword">if</span> (!opts.chmod) opts.chmod = promisify(opts.Promise, fs.chmod)

  opts.top = <span class="hljs-keyword">from</span>
  opts.mkdirpAsync = promisify(opts.Promise, mkdirp)
  <span class="hljs-keyword">var</span> rimrafAsync = promisify(opts.Promise, rimraf)

  <span class="hljs-keyword">var</span> queue = <span class="hljs-keyword">new</span> RunQueue({
    <span class="hljs-attr">maxConcurrency</span>: opts.maxConcurrency,
    <span class="hljs-attr">Promise</span>: <span class="hljs-built_in">Promise</span>
  })
  opts.queue = queue

  queue.add(<span class="hljs-number">0</span>, copyItem, [<span class="hljs-keyword">from</span>, to, opts])

  <span class="hljs-keyword">return</span> queue.run().catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>if the target already exists don't clobber it</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span> (err.code === <span class="hljs-string">'EEXIST'</span> || err.code === <span class="hljs-string">'EPERM'</span>) {
      <span class="hljs-keyword">return</span> passThroughError()
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> remove(to).then(passThroughError, passThroughError)
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">passThroughError</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(err)
    }
  })

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">remove</span> (<span class="hljs-params">target</span>) </span>{
    <span class="hljs-keyword">var</span> opts = {
      <span class="hljs-attr">unlink</span>: fs.unlink,
      <span class="hljs-attr">chmod</span>: fs.chmod,
      <span class="hljs-attr">stat</span>: fs.stat,
      <span class="hljs-attr">lstat</span>: fs.lstat,
      <span class="hljs-attr">rmdir</span>: fs.rmdir,
      <span class="hljs-attr">readdir</span>: fs.readdir,
      <span class="hljs-attr">glob</span>: <span class="hljs-literal">false</span>
    }
    <span class="hljs-keyword">return</span> rimrafAsync(target, opts)
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copyItem</span> (<span class="hljs-params">from, to, opts</span>) </span>{
  validate(<span class="hljs-string">'SSO'</span>, [<span class="hljs-keyword">from</span>, to, opts])
  <span class="hljs-keyword">var</span> fs = opts.fs || nodeFs
  <span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = opts.Promise || global.Promise
  <span class="hljs-keyword">var</span> lstat = opts.lstat || promisify(<span class="hljs-built_in">Promise</span>, fs.lstat)

  <span class="hljs-keyword">return</span> lstat(to).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(eexists(<span class="hljs-keyword">from</span>, to))
  }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (err &amp;&amp; err.code !== <span class="hljs-string">'ENOENT'</span>) <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(err)
    <span class="hljs-keyword">return</span> lstat(<span class="hljs-keyword">from</span>)
  }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fromStat</span>) </span>{
    <span class="hljs-keyword">var</span> cmdOpts = extend(extend({}, opts), fromStat)
    <span class="hljs-keyword">if</span> (fromStat.isDirectory()) {
      <span class="hljs-keyword">return</span> recurseDir(<span class="hljs-keyword">from</span>, to, cmdOpts)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fromStat.isSymbolicLink()) {
      opts.queue.add(<span class="hljs-number">1</span>, copySymlink, [<span class="hljs-keyword">from</span>, to, cmdOpts])
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fromStat.isFile()) {
      <span class="hljs-keyword">return</span> copyFile(<span class="hljs-keyword">from</span>, to, cmdOpts)
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fromStat.isBlockDevice()) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(eunsupported(<span class="hljs-keyword">from</span> + <span class="hljs-string">" is a block device, and we don't know how to copy those."</span>))
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fromStat.isCharacterDevice()) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(eunsupported(<span class="hljs-keyword">from</span> + <span class="hljs-string">" is a character device, and we don't know how to copy those."</span>))
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fromStat.isFIFO()) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(eunsupported(<span class="hljs-keyword">from</span> + <span class="hljs-string">" is a FIFO, and we don't know how to copy those."</span>))
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fromStat.isSocket()) {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(eunsupported(<span class="hljs-keyword">from</span> + <span class="hljs-string">" is a socket, and we don't know how to copy those."</span>))
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(eunsupported(<span class="hljs-string">"We can't tell what "</span> + <span class="hljs-keyword">from</span> + <span class="hljs-string">" is and so we can't copy it."</span>))
    }
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">recurseDir</span> (<span class="hljs-params">from, to, opts</span>) </span>{
  validate(<span class="hljs-string">'SSO'</span>, [<span class="hljs-keyword">from</span>, to, opts])
  <span class="hljs-keyword">var</span> recurseWith = opts.recurseWith || copyItem
  <span class="hljs-keyword">var</span> fs = opts.fs || nodeFs
  <span class="hljs-keyword">var</span> chown = opts.chown || promisify(<span class="hljs-built_in">Promise</span>, fs.chown)
  <span class="hljs-keyword">var</span> readdir = opts.readdir || promisify(<span class="hljs-built_in">Promise</span>, fs.readdir)
  <span class="hljs-keyword">var</span> mkdirpAsync = opts.mkdirpAsync || promisify(<span class="hljs-built_in">Promise</span>, mkdirp)

  <span class="hljs-keyword">return</span> mkdirpAsync(to, {<span class="hljs-attr">fs</span>: fs, <span class="hljs-attr">mode</span>: opts.mode}).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> getuid = opts.getuid || process.getuid
    <span class="hljs-keyword">if</span> (getuid &amp;&amp; opts.uid != <span class="hljs-literal">null</span> &amp;&amp; getuid() === <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> chown(to, opts.uid, opts.gid)
    }
  }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> readdir(<span class="hljs-keyword">from</span>)
  }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">files</span>) </span>{
    files.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">file</span>) </span>{
      opts.queue.add(<span class="hljs-number">0</span>, recurseWith, [path.join(<span class="hljs-keyword">from</span>, file), path.join(to, file), opts])
    })
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copySymlink</span> (<span class="hljs-params">from, to, opts</span>) </span>{
  validate(<span class="hljs-string">'SSO'</span>, [<span class="hljs-keyword">from</span>, to, opts])
  <span class="hljs-keyword">var</span> fs = opts.fs || nodeFs
  <span class="hljs-keyword">var</span> readlink = opts.readlink || promisify(<span class="hljs-built_in">Promise</span>, fs.readlink)
  <span class="hljs-keyword">var</span> stat = opts.stat || promisify(<span class="hljs-built_in">Promise</span>, fs.symlink)
  <span class="hljs-keyword">var</span> symlink = opts.symlink || promisify(<span class="hljs-built_in">Promise</span>, fs.symlink)
  <span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = opts.Promise || global.Promise

  <span class="hljs-keyword">return</span> readlink(<span class="hljs-keyword">from</span>).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fromDest</span>) </span>{
    <span class="hljs-keyword">var</span> absoluteDest = path.resolve(path.dirname(<span class="hljs-keyword">from</span>), fromDest)
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Treat absolute paths that are inside the tree we're
copying as relative. This necessary to properly support junctions
on windows (which are always absolute) but is also DWIM with symlinks.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> relativeDest = path.relative(opts.top, absoluteDest)
    <span class="hljs-keyword">var</span> linkFrom = relativeDest.substr(<span class="hljs-number">0</span>, <span class="hljs-number">2</span>) === <span class="hljs-string">'..'</span> ? fromDest : path.relative(path.dirname(<span class="hljs-keyword">from</span>), absoluteDest)
    <span class="hljs-keyword">if</span> (opts.isWindows) {
      <span class="hljs-keyword">return</span> stat(absoluteDest).catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{ <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span> }).then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">destStat</span>) </span>{
        <span class="hljs-keyword">var</span> isDir = destStat &amp;&amp; destStat.isDirectory()
        <span class="hljs-keyword">var</span> type = isDir ? <span class="hljs-string">'dir'</span> : <span class="hljs-string">'file'</span>
        <span class="hljs-keyword">return</span> symlink(linkFrom, to, type).catch(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">err</span>) </span>{
          <span class="hljs-keyword">if</span> (type === <span class="hljs-string">'dir'</span>) {
            <span class="hljs-keyword">return</span> symlink(linkFrom, to, <span class="hljs-string">'junction'</span>)
          } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-built_in">Promise</span>.reject(err)
          }
        })
      })
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> symlink(linkFrom, to)
    }
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">copyFile</span> (<span class="hljs-params">from, to, opts</span>) </span>{
  validate(<span class="hljs-string">'SSO'</span>, [<span class="hljs-keyword">from</span>, to, opts])
  <span class="hljs-keyword">var</span> fs = opts.fs || nodeFs
  <span class="hljs-keyword">var</span> writeStreamAtomic = opts.writeStreamAtomic || stockWriteStreamAtomic
  <span class="hljs-keyword">var</span> <span class="hljs-built_in">Promise</span> = opts.Promise || global.Promise
  <span class="hljs-keyword">var</span> chmod = opts.chmod || promisify(<span class="hljs-built_in">Promise</span>, fs.chmod)

  <span class="hljs-keyword">var</span> writeOpts = {}
  <span class="hljs-keyword">var</span> getuid = opts.getuid || process.getuid
  <span class="hljs-keyword">if</span> (getuid &amp;&amp; opts.uid != <span class="hljs-literal">null</span> &amp;&amp; getuid() === <span class="hljs-number">0</span>) {
    writeOpts.chown = {
      <span class="hljs-attr">uid</span>: opts.uid,
      <span class="hljs-attr">gid</span>: opts.gid
    }
  }

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
    <span class="hljs-keyword">var</span> errored = <span class="hljs-literal">false</span>
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onError</span> (<span class="hljs-params">err</span>) </span>{
      errored = <span class="hljs-literal">true</span>
      reject(err)
    }
    fs.createReadStream(<span class="hljs-keyword">from</span>)
      .once(<span class="hljs-string">'error'</span>, onError)
      .pipe(writeStreamAtomic(to, writeOpts))
      .once(<span class="hljs-string">'error'</span>, onError)
      .once(<span class="hljs-string">'close'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (errored) <span class="hljs-keyword">return</span>
        <span class="hljs-keyword">if</span> (opts.mode != <span class="hljs-literal">null</span>) {
          resolve(chmod(to, opts.mode))
        } <span class="hljs-keyword">else</span> {
          resolve()
        }
      })
  })
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eexists</span> (<span class="hljs-params">from, to</span>) </span>{
  <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Could not move '</span> + <span class="hljs-keyword">from</span> + <span class="hljs-string">' to '</span> + to + <span class="hljs-string">': destination already exists.'</span>)
  err.code = <span class="hljs-string">'EEXIST'</span>
  <span class="hljs-keyword">return</span> err
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">eunsupported</span> (<span class="hljs-params">msg</span>) </span>{
  <span class="hljs-keyword">var</span> err = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(msg)
  err.code = <span class="hljs-string">'EUNSUPPORTED'</span>
  <span class="hljs-keyword">return</span> err
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
