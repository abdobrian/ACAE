<!DOCTYPE html>
<html>
<head>
  <title>zipEntry.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "ClientApp\\node_modules\\adm-zip\\zipEntry.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>zipEntry.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> Utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./util"</span>),
    Headers = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./headers"</span>),
    Constants = Utils.Constants,
    Methods = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./methods"</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/*Buffer*/i</span>nput</span>) </span>{

    <span class="hljs-keyword">var</span> _entryHeader = <span class="hljs-keyword">new</span> Headers.EntryHeader(),
        _entryName = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>),
        _comment = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>),
        _isDirectory = <span class="hljs-literal">false</span>,
        uncompressedData = <span class="hljs-literal">null</span>,
        _extra = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>);

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getCompressedDataFromZip</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (!input || !Buffer.isBuffer(input)) {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>);
        }
        _entryHeader.loadDataHeaderFromBinary(input);
        <span class="hljs-keyword">return</span> input.slice(_entryHeader.realDataOffset, _entryHeader.realDataOffset + _entryHeader.compressedSize)
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">crc32OK</span>(<span class="hljs-params">data</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>if bit 3 (0x08) of the general-purpose flags field is set, then the CRC-32 and file sizes are not known when the header is written</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (_entryHeader.flags &amp; <span class="hljs-number">0x8</span> != <span class="hljs-number">0x8</span>) {
           <span class="hljs-keyword">if</span> (Utils.crc32(data) != _entryHeader.crc) {
               <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
           }
        } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>@TODO: load and check data descriptor header
The fields in the local header are filled with zero, and the CRC-32 and size are appended in a 12-byte structure
(optionally preceded by a 4-byte signature) immediately after the compressed data:</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">decompress</span>(<span class="hljs-params"><span class="hljs-regexp">/*Boolean*/</span>async, <span class="hljs-regexp">/*Function*/</span>callback, <span class="hljs-regexp">/*String*/</span>pass</span>) </span>{
        <span class="hljs-keyword">if</span>(<span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'undefined'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> <span class="hljs-keyword">async</span> === <span class="hljs-string">'string'</span>) {
            pass=<span class="hljs-keyword">async</span>;
            <span class="hljs-keyword">async</span>=<span class="hljs-keyword">void</span> <span class="hljs-number">0</span>;
        }
        <span class="hljs-keyword">if</span> (_isDirectory) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">async</span> &amp;&amp; callback) {
                callback(<span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>), Utils.Errors.DIRECTORY_CONTENT_ERROR); <span class="hljs-comment">//si added error.</span>
            }
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>);
        }

        <span class="hljs-keyword">var</span> compressedData = getCompressedDataFromZip();
       
        <span class="hljs-keyword">if</span> (compressedData.length == <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">async</span> &amp;&amp; callback) callback(compressedData, Utils.Errors.NO_DATA);<span class="hljs-comment">//si added error.</span>
            <span class="hljs-keyword">return</span> compressedData;
        }

        <span class="hljs-keyword">var</span> data = <span class="hljs-keyword">new</span> Buffer(_entryHeader.size);
        data.fill(<span class="hljs-number">0</span>);

        <span class="hljs-keyword">switch</span> (_entryHeader.method) {
            <span class="hljs-keyword">case</span> Utils.Constants.STORED:
                compressedData.copy(data);
                <span class="hljs-keyword">if</span> (!crc32OK(data)) {
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">async</span> &amp;&amp; callback) callback(data, Utils.Errors.BAD_CRC);<span class="hljs-comment">//si added error</span>
                    <span class="hljs-keyword">return</span> Utils.Errors.BAD_CRC;
                } <span class="hljs-keyword">else</span> {<span class="hljs-comment">//si added otherwise did not seem to return data.</span>
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">async</span> &amp;&amp; callback) callback(data);
                    <span class="hljs-keyword">return</span> data;
                }
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">case</span> Utils.Constants.DEFLATED:
                <span class="hljs-keyword">var</span> inflater = <span class="hljs-keyword">new</span> Methods.Inflater(compressedData);
                <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">async</span>) {
                    inflater.inflate(data);
                    <span class="hljs-keyword">if</span> (!crc32OK(data)) {
                        <span class="hljs-built_in">console</span>.warn(Utils.Errors.BAD_CRC + <span class="hljs-string">" "</span> + _entryName.toString())
                    }
                    <span class="hljs-keyword">return</span> data;
                } <span class="hljs-keyword">else</span> {
                    inflater.inflateAsync(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">result</span>) </span>{
                        result.copy(data, <span class="hljs-number">0</span>);
                        <span class="hljs-keyword">if</span> (!crc32OK(data)) {
                            <span class="hljs-keyword">if</span> (callback) callback(data, Utils.Errors.BAD_CRC); <span class="hljs-comment">//si added error</span>
                        } <span class="hljs-keyword">else</span> { <span class="hljs-comment">//si added otherwise did not seem to return data.</span>
                            <span class="hljs-keyword">if</span> (callback) callback(data);
                        }
                    })
                }
                <span class="hljs-keyword">break</span>;
            <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">if</span> (<span class="hljs-keyword">async</span> &amp;&amp; callback) callback(<span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>), Utils.Errors.UNKNOWN_METHOD);
                <span class="hljs-keyword">return</span> Utils.Errors.UNKNOWN_METHOD;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compress</span>(<span class="hljs-params"><span class="hljs-regexp">/*Boolean*/</span>async, <span class="hljs-regexp">/*Function*/</span>callback</span>) </span>{
        <span class="hljs-keyword">if</span> ((!uncompressedData || !uncompressedData.length) &amp;&amp; Buffer.isBuffer(input)) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>no data set or the data wasn't changed to require recompression</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">async</span> &amp;&amp; callback) callback(getCompressedDataFromZip());
            <span class="hljs-keyword">return</span> getCompressedDataFromZip();
        }

        <span class="hljs-keyword">if</span> (uncompressedData.length &amp;&amp; !_isDirectory) {
            <span class="hljs-keyword">var</span> compressedData;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Local file header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">switch</span> (_entryHeader.method) {
                <span class="hljs-keyword">case</span> Utils.Constants.STORED:
                    _entryHeader.compressedSize = _entryHeader.size;

                    compressedData = <span class="hljs-keyword">new</span> Buffer(uncompressedData.length);
                    uncompressedData.copy(compressedData);

                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">async</span> &amp;&amp; callback) callback(compressedData);
                    <span class="hljs-keyword">return</span> compressedData;

                    <span class="hljs-keyword">break</span>;
                <span class="hljs-keyword">default</span>:
                <span class="hljs-keyword">case</span> Utils.Constants.DEFLATED:

                    <span class="hljs-keyword">var</span> deflater = <span class="hljs-keyword">new</span> Methods.Deflater(uncompressedData);
                    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">async</span>) {
                        <span class="hljs-keyword">var</span> deflated = deflater.deflate();
                        _entryHeader.compressedSize = deflated.length;
                        <span class="hljs-keyword">return</span> deflated;
                    } <span class="hljs-keyword">else</span> {
                        deflater.deflateAsync(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) </span>{
                            compressedData = <span class="hljs-keyword">new</span> Buffer(data.length);
                            _entryHeader.compressedSize = data.length;
                            data.copy(compressedData);
                            callback &amp;&amp; callback(compressedData);
                        })
                    }
                    deflater = <span class="hljs-literal">null</span>;
                    <span class="hljs-keyword">break</span>;
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">async</span> &amp;&amp; callback) {
                callback(<span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>));
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>);
            }
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readUInt64LE</span>(<span class="hljs-params">buffer, offset</span>) </span>{
        <span class="hljs-keyword">return</span> (buffer.readUInt32LE(offset + <span class="hljs-number">4</span>) &lt;&lt; <span class="hljs-number">4</span>) + buffer.readUInt32LE(offset);
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseExtra</span>(<span class="hljs-params">data</span>) </span>{
        <span class="hljs-keyword">var</span> offset = <span class="hljs-number">0</span>;
        <span class="hljs-keyword">var</span> signature, size, part;
        <span class="hljs-keyword">while</span>(offset&lt;data.length) {
            signature = data.readUInt16LE(offset);
            offset += <span class="hljs-number">2</span>;
            size = data.readUInt16LE(offset);
            offset += <span class="hljs-number">2</span>;
            part = data.slice(offset, offset+size);
            offset += size;
            <span class="hljs-keyword">if</span>(Constants.ID_ZIP64 === signature) {
                parseZip64ExtendedInformation(part);
            }
        }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Override header field values with values from the ZIP64 extra field</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseZip64ExtendedInformation</span>(<span class="hljs-params">data</span>) </span>{
        <span class="hljs-keyword">var</span> size, compressedSize, offset, diskNumStart;

        <span class="hljs-keyword">if</span>(data.length &gt;= Constants.EF_ZIP64_SCOMP) {
            size = readUInt64LE(data, Constants.EF_ZIP64_SUNCOMP);
            <span class="hljs-keyword">if</span>(_entryHeader.size === Constants.EF_ZIP64_OR_32) {
                _entryHeader.size = size;
            }
        }
        <span class="hljs-keyword">if</span>(data.length &gt;= Constants.EF_ZIP64_RHO) {
            compressedSize = readUInt64LE(data, Constants.EF_ZIP64_SCOMP);
            <span class="hljs-keyword">if</span>(_entryHeader.compressedSize === Constants.EF_ZIP64_OR_32) {
                _entryHeader.compressedSize = compressedSize;
            }
        }
        <span class="hljs-keyword">if</span>(data.length &gt;= Constants.EF_ZIP64_DSN) {
            offset = readUInt64LE(data, Constants.EF_ZIP64_RHO);
            <span class="hljs-keyword">if</span>(_entryHeader.offset === Constants.EF_ZIP64_OR_32) {
                _entryHeader.offset = offset;
            }
        }
        <span class="hljs-keyword">if</span>(data.length &gt;= Constants.EF_ZIP64_DSN+<span class="hljs-number">4</span>) {
            diskNumStart = data.readUInt32LE(Constants.EF_ZIP64_DSN);
            <span class="hljs-keyword">if</span>(_entryHeader.diskNumStart === Constants.EF_ZIP64_OR_16) {
                _entryHeader.diskNumStart = diskNumStart;
            }
        }
    }


    <span class="hljs-keyword">return</span> {
        get entryName () { <span class="hljs-keyword">return</span> _entryName.toString(); },
        get rawEntryName() { <span class="hljs-keyword">return</span> _entryName; },
        set entryName (val) {
            _entryName = Utils.toBuffer(val);
            <span class="hljs-keyword">var</span> lastChar = _entryName[_entryName.length - <span class="hljs-number">1</span>];
            _isDirectory = (lastChar == <span class="hljs-number">47</span>) || (lastChar == <span class="hljs-number">92</span>);
            _entryHeader.fileNameLength = _entryName.length;
        },

        get extra () { <span class="hljs-keyword">return</span> _extra; },
        set extra (val) {
            _extra = val;
            _entryHeader.extraLength = val.length;
            parseExtra(val);
        },

        get comment () { <span class="hljs-keyword">return</span> _comment.toString(); },
        set comment (val) {
            _comment = Utils.toBuffer(val);
            _entryHeader.commentLength = _comment.length;
        },

        get name () { <span class="hljs-keyword">var</span> n = _entryName.toString(); <span class="hljs-keyword">return</span> _isDirectory ? n.substr(n.length - <span class="hljs-number">1</span>).split(<span class="hljs-string">"/"</span>).pop() : n.split(<span class="hljs-string">"/"</span>).pop(); },
        get isDirectory () { <span class="hljs-keyword">return</span> _isDirectory },

        <span class="hljs-attr">getCompressedData</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> compress(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>)
        },

        <span class="hljs-attr">getCompressedDataAsync</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*Function*/</span>callback</span>) </span>{
            compress(<span class="hljs-literal">true</span>, callback)
        },

        <span class="hljs-attr">setData</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">value</span>) </span>{
            uncompressedData = Utils.toBuffer(value);
            <span class="hljs-keyword">if</span> (!_isDirectory &amp;&amp; uncompressedData.length) {
                _entryHeader.size = uncompressedData.length;
                _entryHeader.method = Utils.Constants.DEFLATED;
                _entryHeader.crc = Utils.crc32(value);
            } <span class="hljs-keyword">else</span> { <span class="hljs-comment">// folders and blank files should be stored</span>
                _entryHeader.method = Utils.Constants.STORED;
            }
        },

        <span class="hljs-attr">getData</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">pass</span>) </span>{
            <span class="hljs-keyword">return</span> decompress(<span class="hljs-literal">false</span>, <span class="hljs-literal">null</span>, pass);
        },

        <span class="hljs-attr">getDataAsync</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*Function*/</span>callback, pass</span>) </span>{
            decompress(<span class="hljs-literal">true</span>, callback, pass)
        },

        set attr(attr) { _entryHeader.attr = attr; },
        get attr() { <span class="hljs-keyword">return</span> _entryHeader.attr; },

        set header(<span class="hljs-comment">/*Buffer*/</span>data) {
            _entryHeader.loadFromBinary(data);
        },

        get header() {
            <span class="hljs-keyword">return</span> _entryHeader;
        },

        <span class="hljs-attr">packHeader</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">var</span> header = _entryHeader.entryHeaderToBinary();
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>add</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            _entryName.copy(header, Utils.Constants.CENHDR);
            <span class="hljs-keyword">if</span> (_entryHeader.extraLength) {
                _extra.copy(header, Utils.Constants.CENHDR + _entryName.length)
            }
            <span class="hljs-keyword">if</span> (_entryHeader.commentLength) {
                _comment.copy(header, Utils.Constants.CENHDR + _entryName.length + _entryHeader.extraLength, _comment.length);
            }
            <span class="hljs-keyword">return</span> header;
        },

        <span class="hljs-attr">toString</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">return</span> <span class="hljs-string">'{\n'</span> +
                <span class="hljs-string">'\t"entryName" : "'</span> + _entryName.toString() + <span class="hljs-string">"\",\n"</span> +
                <span class="hljs-string">'\t"name" : "'</span> + _entryName.toString().split(<span class="hljs-string">"/"</span>).pop() + <span class="hljs-string">"\",\n"</span> +
                <span class="hljs-string">'\t"comment" : "'</span> + _comment.toString() + <span class="hljs-string">"\",\n"</span> +
                <span class="hljs-string">'\t"isDirectory" : '</span> + _isDirectory + <span class="hljs-string">",\n"</span> +
                <span class="hljs-string">'\t"header" : '</span> + _entryHeader.toString().replace(<span class="hljs-regexp">/\t/mg</span>, <span class="hljs-string">"\t\t"</span>) + <span class="hljs-string">",\n"</span> +
                <span class="hljs-string">'\t"compressedData" : &lt;'</span> + (input &amp;&amp; input.length  + <span class="hljs-string">" bytes buffer"</span> || <span class="hljs-string">"null"</span>) + <span class="hljs-string">"&gt;\n"</span> +
                <span class="hljs-string">'\t"data" : &lt;'</span> + (uncompressedData &amp;&amp; uncompressedData.length  + <span class="hljs-string">" bytes buffer"</span> || <span class="hljs-string">"null"</span>) + <span class="hljs-string">"&gt;\n"</span> +
                <span class="hljs-string">'}'</span>;
        }
    }
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
