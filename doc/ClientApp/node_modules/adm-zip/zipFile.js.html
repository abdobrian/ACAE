<!DOCTYPE html>
<html>
<head>
  <title>zipFile.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "ClientApp\\node_modules\\adm-zip\\zipFile.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>zipFile.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> ZipEntry = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./zipEntry"</span>),
    Headers = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./headers"</span>),
    Utils = <span class="hljs-built_in">require</span>(<span class="hljs-string">"./util"</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*String|Buffer*/i</span>nput, <span class="hljs-regexp">/*Number*/i</span>nputType</span>) </span>{
    <span class="hljs-keyword">var</span> entryList = [],
        entryTable = {},
        _comment = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">0</span>),
        filename = <span class="hljs-string">""</span>,
        fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">"fs"</span>),
        inBuffer = <span class="hljs-literal">null</span>,
        mainHeader = <span class="hljs-keyword">new</span> Headers.MainHeader();

    <span class="hljs-keyword">if</span> (inputType == Utils.Constants.FILE) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>is a filename</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        filename = input;
        inBuffer = fs.readFileSync(filename);
        readMainHeader();
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (inputType == Utils.Constants.BUFFER) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>is a memory buffer</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        inBuffer = input;
        readMainHeader();
    } <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>none. is a new file</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readEntries</span>(<span class="hljs-params"></span>) </span>{
        entryTable = {};
        entryList = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(mainHeader.diskEntries);  <span class="hljs-comment">// total number of entries</span>
        <span class="hljs-keyword">var</span> index = mainHeader.offset;  <span class="hljs-comment">// offset of first CEN header</span>
        <span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; entryList.length; i++) {

            <span class="hljs-keyword">var</span> tmp = index,
                entry = <span class="hljs-keyword">new</span> ZipEntry(inBuffer);
            entry.header = inBuffer.slice(tmp, tmp += Utils.Constants.CENHDR);

            entry.entryName = inBuffer.slice(tmp, tmp += entry.header.fileNameLength);

            <span class="hljs-keyword">if</span> (entry.header.extraLength) {
                entry.extra = inBuffer.slice(tmp, tmp += entry.header.extraLength);
            }

            <span class="hljs-keyword">if</span> (entry.header.commentLength)
                entry.comment = inBuffer.slice(tmp, tmp + entry.header.commentLength);

            index += entry.header.entryHeaderSize;

            entryList[i] = entry;
            entryTable[entry.entryName] = entry;
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readMainHeader</span>(<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> i = inBuffer.length - Utils.Constants.ENDHDR, <span class="hljs-comment">// END header size</span>
            n = <span class="hljs-built_in">Math</span>.max(<span class="hljs-number">0</span>, i - <span class="hljs-number">0xFFFF</span>), <span class="hljs-comment">// 0xFFFF is the max zip file comment length</span>
            endOffset = <span class="hljs-number">-1</span>; <span class="hljs-comment">// Start offset of the END header</span>

        <span class="hljs-keyword">for</span> (i; i &gt;= n; i--) {
            <span class="hljs-keyword">if</span> (inBuffer[i] != <span class="hljs-number">0x50</span>) <span class="hljs-keyword">continue</span>; <span class="hljs-comment">// quick check that the byte is 'P'</span>
            <span class="hljs-keyword">if</span> (inBuffer.readUInt32LE(i) == Utils.Constants.ENDSIG) { <span class="hljs-comment">// "PK\005\006"</span>
                endOffset = i;
                <span class="hljs-keyword">break</span>;
            }
        }
        <span class="hljs-keyword">if</span> (!~endOffset)
            <span class="hljs-keyword">throw</span> Utils.Errors.INVALID_FORMAT;

        mainHeader.loadFromBinary(inBuffer.slice(endOffset, endOffset + Utils.Constants.ENDHDR));
        <span class="hljs-keyword">if</span> (mainHeader.commentLength) {
            _comment = inBuffer.slice(endOffset + Utils.Constants.ENDHDR);
        }
        readEntries();
    }

    <span class="hljs-keyword">return</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>Returns an array of ZipEntry objects existent in the current opened archive</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>Array
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        get entries () {
            <span class="hljs-keyword">return</span> entryList;
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
<p>Archive comment</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">String</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        get comment () { <span class="hljs-keyword">return</span> _comment.toString(); },
        set comment(val) {
            mainHeader.commentLength = val.length;
            _comment = val;
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<div class="dox">
<div class="summary">
<p>Returns a reference to the entry with the given name or null if entry is inexistent</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entryName</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>ZipEntry
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        getEntry : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*String*/</span>entryName</span>) </span>{
            <span class="hljs-keyword">return</span> entryTable[entryName] || <span class="hljs-literal">null</span>;
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<div class="dox">
<div class="summary">
<p>Adds the given entry to the entry list</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entry</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        setEntry : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*ZipEntry*/</span>entry</span>) </span>{
            entryList.push(entry);
            entryTable[entry.entryName] = entry;
            mainHeader.totalEntries = entryList.length;
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<div class="dox">
<div class="summary">
<p>Removes the entry with the given name from the entry list.</p>
<p>If the entry is a directory, then all nested files and directories will be removed</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entryName</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        deleteEntry : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*String*/</span>entryName</span>) </span>{
            <span class="hljs-keyword">var</span> entry = entryTable[entryName];
            <span class="hljs-keyword">if</span> (entry &amp;&amp; entry.isDirectory) {
                <span class="hljs-keyword">var</span> _self = <span class="hljs-keyword">this</span>;
                <span class="hljs-keyword">this</span>.getEntryChildren(entry).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">child</span>) </span>{
                    <span class="hljs-keyword">if</span> (child.entryName != entryName) {
                        _self.deleteEntry(child.entryName)
                    }
                })
            }
            entryList.splice(entryList.indexOf(entry), <span class="hljs-number">1</span>);
            <span class="hljs-keyword">delete</span>(entryTable[entryName]);
            mainHeader.totalEntries = entryList.length;
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<div class="dox">
<div class="summary">
<p>Iterates and returns all nested files and directories of the given entry</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">entry</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>Array
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        getEntryChildren : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*ZipEntry*/</span>entry</span>) </span>{
            <span class="hljs-keyword">if</span> (entry.isDirectory) {
                <span class="hljs-keyword">var</span> list = [],
                    name = entry.entryName,
                    len = name.length;

                entryList.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">zipEntry</span>) </span>{
                    <span class="hljs-keyword">if</span> (zipEntry.entryName.substr(<span class="hljs-number">0</span>, len) == name) {
                        list.push(zipEntry);
                    }
                });
                <span class="hljs-keyword">return</span> list;
            }
            <span class="hljs-keyword">return</span> []
        },

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<div class="dox">
<div class="summary">
<p>Returns the zip file</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span>Buffer
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        compressToBuffer : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
            <span class="hljs-keyword">if</span> (entryList.length &gt; <span class="hljs-number">1</span>) {
                entryList.sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
                    <span class="hljs-keyword">var</span> nameA = a.entryName.toLowerCase();
                    <span class="hljs-keyword">var</span> nameB = b.entryName.toLowerCase();
                    <span class="hljs-keyword">if</span> (nameA &lt; nameB) {<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>}
                    <span class="hljs-keyword">if</span> (nameA &gt; nameB) {<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>}
                    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
                });
            }

            <span class="hljs-keyword">var</span> totalSize = <span class="hljs-number">0</span>,
                dataBlock = [],
                entryHeaders = [],
                dindex = <span class="hljs-number">0</span>;

            mainHeader.size = <span class="hljs-number">0</span>;
            mainHeader.offset = <span class="hljs-number">0</span>;

            entryList.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entry</span>) </span>{
                entry.header.offset = dindex;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>compress data and set local and entry header accordingly. Reason why is called first</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">var</span> compressedData = entry.getCompressedData();
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>data header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                <span class="hljs-keyword">var</span> dataHeader = entry.header.dataHeaderToBinary();
                <span class="hljs-keyword">var</span> postHeader = <span class="hljs-keyword">new</span> Buffer(entry.entryName + entry.extra.toString());
                <span class="hljs-keyword">var</span> dataLength = dataHeader.length + postHeader.length + compressedData.length;

                dindex += dataLength;

                dataBlock.push(dataHeader);
                dataBlock.push(postHeader);
                dataBlock.push(compressedData);

                <span class="hljs-keyword">var</span> entryHeader = entry.packHeader();
                entryHeaders.push(entryHeader);
                mainHeader.size += entryHeader.length;
                totalSize += (dataLength + entryHeader.length);
            });

            totalSize += mainHeader.mainHeaderSize; <span class="hljs-comment">// also includes zip file comment length</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>point to end of data and begining of central directory first record</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            mainHeader.offset = dindex;

            dindex = <span class="hljs-number">0</span>;
            <span class="hljs-keyword">var</span> outBuffer = <span class="hljs-keyword">new</span> Buffer(totalSize);
            dataBlock.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">content</span>) </span>{
                content.copy(outBuffer, dindex); <span class="hljs-comment">// write data blocks</span>
                dindex += content.length;
            });
            entryHeaders.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">content</span>) </span>{
                content.copy(outBuffer, dindex); <span class="hljs-comment">// write central directory entries</span>
                dindex += content.length;
            });

            <span class="hljs-keyword">var</span> mh = mainHeader.toBinary();
            <span class="hljs-keyword">if</span> (_comment) {
                _comment.copy(mh, Utils.Constants.ENDHDR); <span class="hljs-comment">// add zip file comment</span>
            }

            mh.copy(outBuffer, dindex); <span class="hljs-comment">// write main header</span>

            <span class="hljs-keyword">return</span> outBuffer
        },

        <span class="hljs-attr">toAsyncBuffer</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"><span class="hljs-regexp">/*Function*/</span>onSuccess,<span class="hljs-regexp">/*Function*/</span>onFail,<span class="hljs-regexp">/*Function*/</span>onItemStart,<span class="hljs-regexp">/*Function*/</span>onItemEnd</span>) </span>{
            <span class="hljs-keyword">if</span> (entryList.length &gt; <span class="hljs-number">1</span>) {
                entryList.sort(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">a, b</span>) </span>{
                    <span class="hljs-keyword">var</span> nameA = a.entryName.toLowerCase();
                    <span class="hljs-keyword">var</span> nameB = b.entryName.toLowerCase();
                    <span class="hljs-keyword">if</span> (nameA &gt; nameB) {<span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>}
                    <span class="hljs-keyword">if</span> (nameA &lt; nameB) {<span class="hljs-keyword">return</span> <span class="hljs-number">1</span>}
                    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
                });
            }

            <span class="hljs-keyword">var</span> totalSize = <span class="hljs-number">0</span>,
                dataBlock = [],
                entryHeaders = [],
                dindex = <span class="hljs-number">0</span>;

            mainHeader.size = <span class="hljs-number">0</span>;
            mainHeader.offset = <span class="hljs-number">0</span>;

            <span class="hljs-keyword">var</span> compress=<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">entryList</span>)</span>{
                <span class="hljs-keyword">var</span> self=<span class="hljs-built_in">arguments</span>.callee;
                <span class="hljs-keyword">var</span> entry;
                <span class="hljs-keyword">if</span>(entryList.length){
                    <span class="hljs-keyword">var</span> entry=entryList.pop();
                    <span class="hljs-keyword">var</span> name=entry.entryName + entry.extra.toString();
                    <span class="hljs-keyword">if</span>(onItemStart)onItemStart(name);
                    entry.getCompressedDataAsync(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">compressedData</span>)</span>{
                        <span class="hljs-keyword">if</span>(onItemEnd)onItemEnd(name);

                        entry.header.offset = dindex;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>data header</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                        <span class="hljs-keyword">var</span> dataHeader = entry.header.dataHeaderToBinary();
                        <span class="hljs-keyword">var</span> postHeader = <span class="hljs-keyword">new</span> Buffer(name);
                        <span class="hljs-keyword">var</span> dataLength = dataHeader.length + postHeader.length + compressedData.length;

                        dindex += dataLength;

                        dataBlock.push(dataHeader);
                        dataBlock.push(postHeader);
                        dataBlock.push(compressedData);

                        <span class="hljs-keyword">var</span> entryHeader = entry.packHeader();
                        entryHeaders.push(entryHeader);
                        mainHeader.size += entryHeader.length;
                        totalSize += (dataLength + entryHeader.length);

                        <span class="hljs-keyword">if</span>(entryList.length){
                            self(entryList);
                        }<span class="hljs-keyword">else</span>{


                            totalSize += mainHeader.mainHeaderSize; <span class="hljs-comment">// also includes zip file comment length</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>point to end of data and begining of central directory first record</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                            mainHeader.offset = dindex;

                            dindex = <span class="hljs-number">0</span>;
                            <span class="hljs-keyword">var</span> outBuffer = <span class="hljs-keyword">new</span> Buffer(totalSize);
                            dataBlock.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">content</span>) </span>{
                                content.copy(outBuffer, dindex); <span class="hljs-comment">// write data blocks</span>
                                dindex += content.length;
                            });
                            entryHeaders.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">content</span>) </span>{
                                content.copy(outBuffer, dindex); <span class="hljs-comment">// write central directory entries</span>
                                dindex += content.length;
                            });

                            <span class="hljs-keyword">var</span> mh = mainHeader.toBinary();
                            <span class="hljs-keyword">if</span> (_comment) {
                                _comment.copy(mh, Utils.Constants.ENDHDR); <span class="hljs-comment">// add zip file comment</span>
                            }

                            mh.copy(outBuffer, dindex); <span class="hljs-comment">// write main header</span>

                            onSuccess(outBuffer);
                        }
                    });
                }
            };

            compress(entryList);
        }
    }
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
