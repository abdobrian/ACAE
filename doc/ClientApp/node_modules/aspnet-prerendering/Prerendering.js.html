<!DOCTYPE html>
<html>
<head>
  <title>Prerendering.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "ClientApp\\node_modules\\aspnet-prerendering\\Prerendering.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>Prerendering.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">"use strict"</span>;
<span class="hljs-built_in">Object</span>.defineProperty(exports, <span class="hljs-string">"__esModule"</span>, { <span class="hljs-attr">value</span>: <span class="hljs-literal">true</span> });
<span class="hljs-keyword">var</span> url = <span class="hljs-built_in">require</span>(<span class="hljs-string">"url"</span>);
<span class="hljs-keyword">var</span> domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">"domain"</span>);
<span class="hljs-keyword">var</span> main_1 = <span class="hljs-built_in">require</span>(<span class="hljs-string">"domain-task/main"</span>);
<span class="hljs-keyword">var</span> defaultTimeoutMilliseconds = <span class="hljs-number">30</span> * <span class="hljs-number">1000</span>;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">createServerRenderer</span>(<span class="hljs-params">bootFunc</span>) </span>{
    <span class="hljs-keyword">var</span> resultFunc = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">callback, applicationBasePath, bootModule, absoluteRequestUrl, requestPathAndQuery, customDataParameter, overrideTimeoutMilliseconds, requestPathBase</span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Prepare a promise that will represent the completion of all domain tasks in this execution context.
The boot code will wait for this before performing its final render.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">var</span> domainTaskCompletionPromiseResolve;
        <span class="hljs-keyword">var</span> domainTaskCompletionPromise = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
            domainTaskCompletionPromiseResolve = resolve;
        });
        <span class="hljs-keyword">var</span> parsedAbsoluteRequestUrl = url.parse(absoluteRequestUrl);
        <span class="hljs-keyword">var</span> params = {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>It's helpful for boot funcs to receive the query as a key-value object, so parse it here
e.g., react-redux-router requires location.query to be a key-value object for consistency with client-side behaviour</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            location: url.parse(requestPathAndQuery, <span class="hljs-comment">/* parseQueryString */</span> <span class="hljs-literal">true</span>),
            <span class="hljs-attr">origin</span>: parsedAbsoluteRequestUrl.protocol + <span class="hljs-string">'//'</span> + parsedAbsoluteRequestUrl.host,
            <span class="hljs-attr">url</span>: requestPathAndQuery,
            <span class="hljs-attr">baseUrl</span>: (requestPathBase || <span class="hljs-string">''</span>) + <span class="hljs-string">'/'</span>,
            <span class="hljs-attr">absoluteUrl</span>: absoluteRequestUrl,
            <span class="hljs-attr">domainTasks</span>: domainTaskCompletionPromise,
            <span class="hljs-attr">data</span>: customDataParameter
        };
        <span class="hljs-keyword">var</span> absoluteBaseUrl = params.origin + params.baseUrl; <span class="hljs-comment">// Should be same value as page's &lt;base href&gt;</span>
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Open a new domain that can track all the async tasks involved in the app's execution</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        main_1.run(<span class="hljs-comment">/* code to run */</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Workaround for Node bug where native Promise continuations lose their domain context
(https://github.com/nodejs/node-v0.x-archive/issues/8648)
The domain.active property is set by the domain-context module</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            bindPromiseContinuationsToDomain(domainTaskCompletionPromise, domain[<span class="hljs-string">'active'</span>]);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Make the base URL available to the 'domain-tasks/fetch' helper within this execution context</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            main_1.baseUrl(absoluteBaseUrl);
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Begin rendering, and apply a timeout</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            <span class="hljs-keyword">var</span> bootFuncPromise = bootFunc(params);
            <span class="hljs-keyword">if</span> (!bootFuncPromise || <span class="hljs-keyword">typeof</span> bootFuncPromise.then !== <span class="hljs-string">'function'</span>) {
                callback(<span class="hljs-string">"Prerendering failed because the boot function in "</span> + bootModule.moduleName + <span class="hljs-string">" did not return a promise."</span>, <span class="hljs-literal">null</span>);
                <span class="hljs-keyword">return</span>;
            }
            <span class="hljs-keyword">var</span> timeoutMilliseconds = overrideTimeoutMilliseconds || defaultTimeoutMilliseconds; <span class="hljs-comment">// e.g., pass -1 to override as 'never time out'</span>
            <span class="hljs-keyword">var</span> bootFuncPromiseWithTimeout = timeoutMilliseconds &gt; <span class="hljs-number">0</span>
                ? wrapWithTimeout(bootFuncPromise, timeoutMilliseconds, <span class="hljs-string">"Prerendering timed out after "</span> + timeoutMilliseconds + <span class="hljs-string">"ms because the boot function in '"</span> + bootModule.moduleName + <span class="hljs-string">"' "</span>
                    + <span class="hljs-string">'returned a promise that did not resolve or reject. Make sure that your boot function always resolves or '</span>
                    + <span class="hljs-string">'rejects its promise. You can change the timeout value using the \'asp-prerender-timeout\' tag helper.'</span>)
                : bootFuncPromise;
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Actually perform the rendering</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">            bootFuncPromiseWithTimeout.then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">successResult</span>) </span>{
                callback(<span class="hljs-literal">null</span>, successResult);
            }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">error</span>) </span>{
                callback(error, <span class="hljs-literal">null</span>);
            });
        }, <span class="hljs-comment">/* completion callback */</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"><span class="hljs-regexp">/* completion callback */</span> errorOrNothing</span>) </span>{
            <span class="hljs-keyword">if</span> (errorOrNothing) {
                callback(errorOrNothing, <span class="hljs-literal">null</span>);
            }
            <span class="hljs-keyword">else</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>There are no more ongoing domain tasks (typically data access operations), so we can resolve
the domain tasks promise which notifies the boot code that it can do its final render.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">                domainTaskCompletionPromiseResolve();
            }
        });
    };
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Indicate to the prerendering code bundled into Microsoft.AspNetCore.SpaServices that this is a serverside rendering
function, so it can be invoked directly. This flag exists only so that, in its absence, we can run some different
backward-compatibility logic.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    resultFunc[<span class="hljs-string">'isServerRenderer'</span>] = <span class="hljs-literal">true</span>;
    <span class="hljs-keyword">return</span> resultFunc;
}
exports.createServerRenderer = createServerRenderer;
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrapWithTimeout</span>(<span class="hljs-params">promise, timeoutMilliseconds, timeoutRejectionValue</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Promise</span>(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolve, reject</span>) </span>{
        <span class="hljs-keyword">var</span> timeoutTimer = setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
            reject(timeoutRejectionValue);
        }, timeoutMilliseconds);
        promise.then(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">resolvedValue</span>) </span>{
            clearTimeout(timeoutTimer);
            resolve(resolvedValue);
        }, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">rejectedValue</span>) </span>{
            clearTimeout(timeoutTimer);
            reject(rejectedValue);
        });
    });
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bindPromiseContinuationsToDomain</span>(<span class="hljs-params">promise, domainInstance</span>) </span>{
    <span class="hljs-keyword">var</span> originalThen = promise.then;
    promise.then = (<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">then</span>(<span class="hljs-params">resolve, reject</span>) </span>{
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> resolve === <span class="hljs-string">'function'</span>) {
            resolve = domainInstance.bind(resolve);
        }
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> reject === <span class="hljs-string">'function'</span>) {
            reject = domainInstance.bind(reject);
        }
        <span class="hljs-keyword">return</span> originalThen.call(<span class="hljs-keyword">this</span>, resolve, reject);
    });
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
