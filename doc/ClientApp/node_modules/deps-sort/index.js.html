<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "ClientApp\\node_modules\\deps-sort\\index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> through = <span class="hljs-built_in">require</span>(<span class="hljs-string">'through2'</span>);
<span class="hljs-keyword">var</span> shasum = <span class="hljs-built_in">require</span>(<span class="hljs-string">'shasum'</span>);

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">opts</span>) </span>{
    <span class="hljs-keyword">if</span> (!opts) opts = {};
    <span class="hljs-keyword">var</span> rows = [];
    <span class="hljs-keyword">return</span> through.obj(write, end);
    
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span> (<span class="hljs-params">row, enc, next</span>) </span>{ rows.push(row); next() }
    
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">end</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">var</span> tr = <span class="hljs-keyword">this</span>;
        rows.sort(cmp);
        sorter(rows, tr, opts);
    }
};

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sorter</span> (<span class="hljs-params">rows, tr, opts</span>) </span>{
    <span class="hljs-keyword">var</span> expose = opts.expose || {};
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(expose)) {
        expose = expose.reduce(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">acc, key</span>) </span>{
            acc[key] = <span class="hljs-literal">true</span>;
            <span class="hljs-keyword">return</span> acc;
        }, {});
    }
    
    <span class="hljs-keyword">var</span> hashes = {}, deduped = {};
    <span class="hljs-keyword">var</span> sameDeps = depCmp();
    
    <span class="hljs-keyword">if</span> (opts.dedupe) {
        rows.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">row</span>) </span>{
            <span class="hljs-keyword">var</span> h = shasum(row.source);
            sameDeps.add(row, h);
            <span class="hljs-keyword">if</span> (hashes[h]) {
                hashes[h].push(row);
            } <span class="hljs-keyword">else</span> {
                hashes[h] = [row];
            }
        });
        <span class="hljs-built_in">Object</span>.keys(hashes).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">h</span>) </span>{
            <span class="hljs-keyword">var</span> rows = hashes[h];
            <span class="hljs-keyword">while</span> (rows.length &gt; <span class="hljs-number">1</span>) {
                <span class="hljs-keyword">var</span> row = rows.pop();
                row.dedupe = rows[<span class="hljs-number">0</span>].id;
                row.sameDeps = sameDeps.cmp(rows[<span class="hljs-number">0</span>].deps, row.deps);
                deduped[row.id] = rows[<span class="hljs-number">0</span>].id;
            }
        });
    }
    
    <span class="hljs-keyword">if</span> (opts.index) {
        <span class="hljs-keyword">var</span> index = {};
        <span class="hljs-keyword">var</span> offset = <span class="hljs-number">0</span>;
        rows.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">row, ix</span>) </span>{
            <span class="hljs-keyword">if</span> (has(expose, row.id)) {
                row.index = row.id;
                offset ++;
                <span class="hljs-keyword">if</span> (expose[row.id] !== <span class="hljs-literal">true</span>) {
                    index[expose[row.id]] = row.index;
                }
            }
            <span class="hljs-keyword">else</span> {
                row.index = ix + <span class="hljs-number">1</span> - offset;
            }
            index[row.id] = row.index;
        });
        rows.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">row</span>) </span>{
            row.indexDeps = {};
            <span class="hljs-built_in">Object</span>.keys(row.deps).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">key</span>) </span>{
                <span class="hljs-keyword">var</span> id = row.deps[key];
                row.indexDeps[key] = index[id];
            });
            <span class="hljs-keyword">if</span> (row.dedupe) {
                row.dedupeIndex = index[row.dedupe];
            }
            tr.push(row);
        });
    }
    <span class="hljs-keyword">else</span> {
        rows.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">row</span>) </span>{ tr.push(row) });
    }
    tr.push(<span class="hljs-literal">null</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmp</span> (<span class="hljs-params">a, b</span>) </span>{
    <span class="hljs-keyword">return</span> a.id + a.hash &lt; b.id + b.hash ? <span class="hljs-number">-1</span> : <span class="hljs-number">1</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">has</span> (<span class="hljs-params">obj, key</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.prototype.hasOwnProperty.call(obj, key);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">depCmp</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> deps = {}, hashes = {};
    <span class="hljs-keyword">return</span> { <span class="hljs-attr">add</span>: add, <span class="hljs-attr">cmp</span>: cmp }
    
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">add</span> (<span class="hljs-params">row, hash</span>) </span>{
        deps[row.id] = row.deps;
        hashes[row.id] = hash;
    }
    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cmp</span> (<span class="hljs-params">a, b, limit</span>) </span>{
        <span class="hljs-keyword">if</span> (!a &amp;&amp; !b) <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
        <span class="hljs-keyword">if</span> (!a || !b) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
        
        <span class="hljs-keyword">var</span> keys = <span class="hljs-built_in">Object</span>.keys(a);
        <span class="hljs-keyword">if</span> (keys.length !== <span class="hljs-built_in">Object</span>.keys(b).length) <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;

        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; keys.length; i++) {
            <span class="hljs-keyword">var</span> k = keys[i], ka = a[k], kb = b[k];
            <span class="hljs-keyword">var</span> ha = hashes[ka];
            <span class="hljs-keyword">var</span> hb = hashes[kb];
            <span class="hljs-keyword">var</span> da = deps[ka];
            <span class="hljs-keyword">var</span> db = deps[kb];

            <span class="hljs-keyword">if</span> (ka === kb) <span class="hljs-keyword">continue</span>;
            <span class="hljs-keyword">if</span> (ha !== hb || (!limit &amp;&amp; !cmp(da, db, <span class="hljs-number">1</span>))) {
                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;
            }
        }
        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;
    }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
