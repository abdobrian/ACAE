<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "ClientApp\\node_modules\\fs-write-stream-atomic\\index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'graceful-fs'</span>)
<span class="hljs-keyword">var</span> Writable = <span class="hljs-built_in">require</span>(<span class="hljs-string">'readable-stream'</span>).Writable
<span class="hljs-keyword">var</span> util = <span class="hljs-built_in">require</span>(<span class="hljs-string">'util'</span>)
<span class="hljs-keyword">var</span> MurmurHash3 = <span class="hljs-built_in">require</span>(<span class="hljs-string">'imurmurhash'</span>)
<span class="hljs-keyword">var</span> iferr = <span class="hljs-built_in">require</span>(<span class="hljs-string">'iferr'</span>)
<span class="hljs-keyword">var</span> crypto = <span class="hljs-built_in">require</span>(<span class="hljs-string">'crypto'</span>)

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">murmurhex</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> hash = MurmurHash3(<span class="hljs-string">''</span>)
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> ii = <span class="hljs-number">0</span>; ii &lt; <span class="hljs-built_in">arguments</span>.length; ++ii) {
    hash.hash(<span class="hljs-string">''</span> + <span class="hljs-built_in">arguments</span>[ii])
  }
  <span class="hljs-keyword">return</span> hash.result()
}

<span class="hljs-keyword">var</span> invocations = <span class="hljs-number">0</span>
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getTmpname</span> (<span class="hljs-params">filename</span>) </span>{
  <span class="hljs-keyword">return</span> filename + <span class="hljs-string">'.'</span> + murmurhex(__filename, process.pid, ++invocations)
}

<span class="hljs-keyword">var</span> setImmediate = global.setImmediate || setTimeout

<span class="hljs-built_in">module</span>.exports = WriteStreamAtomic

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Requirements:</p>
<ol>
<li>Write everything written to the stream to a temp file.</li>
<li>If there are no errors:
a. moves the temp file into its final destination
b. emits <code>finish</code> &amp; <code>closed</code> ONLY after the file is
fully flushed and renamed.</li>
<li>If there's an error, removes the temp file.</li>
</ol>

        </td>
        <td class="code highlight">
          <pre class="javascript">
util.inherits(WriteStreamAtomic, Writable)
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">WriteStreamAtomic</span> (<span class="hljs-params">path, options</span>) </span>{
  <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> WriteStreamAtomic)) {
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> WriteStreamAtomic(path, options)
  }
  Writable.call(<span class="hljs-keyword">this</span>, options)

  <span class="hljs-keyword">this</span>.__isWin = options &amp;&amp; options.hasOwnProperty(<span class="hljs-string">'isWin'</span>) ? options.isWin : process.platform === <span class="hljs-string">'win32'</span>

  <span class="hljs-keyword">this</span>.__atomicTarget = path
  <span class="hljs-keyword">this</span>.__atomicTmp = getTmpname(path)

  <span class="hljs-keyword">this</span>.__atomicChown = options &amp;&amp; options.chown

  <span class="hljs-keyword">this</span>.__atomicClosed = <span class="hljs-literal">false</span>

  <span class="hljs-keyword">this</span>.__atomicStream = fs.WriteStream(<span class="hljs-keyword">this</span>.__atomicTmp, options)

  <span class="hljs-keyword">this</span>.__atomicStream.once(<span class="hljs-string">'open'</span>, handleOpen(<span class="hljs-keyword">this</span>))
  <span class="hljs-keyword">this</span>.__atomicStream.once(<span class="hljs-string">'close'</span>, handleClose(<span class="hljs-keyword">this</span>))
  <span class="hljs-keyword">this</span>.__atomicStream.once(<span class="hljs-string">'error'</span>, handleError(<span class="hljs-keyword">this</span>))
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>We have to suppress default finish emitting, because ordinarily it
would happen as soon as <code>end</code> is called on us and all of the
data has been written to our target stream. So we suppress
finish from being emitted here, and only emit it after our
target stream is closed and we've moved everything around.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">WriteStreamAtomic.prototype.emit = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">event</span>) </span>{
  <span class="hljs-keyword">if</span> (event === <span class="hljs-string">'finish'</span>) <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.__atomicStream.end()
  <span class="hljs-keyword">return</span> Writable.prototype.emit.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>)
}

WriteStreamAtomic.prototype._write = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">buffer, encoding, cb</span>) </span>{
  <span class="hljs-keyword">var</span> flushed = <span class="hljs-keyword">this</span>.__atomicStream.write(buffer, encoding)
  <span class="hljs-keyword">if</span> (flushed) <span class="hljs-keyword">return</span> cb()
  <span class="hljs-keyword">this</span>.__atomicStream.once(<span class="hljs-string">'drain'</span>, cb)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleOpen</span> (<span class="hljs-params">writeStream</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">fd</span>) </span>{
    writeStream.emit(<span class="hljs-string">'open'</span>, fd)
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleClose</span> (<span class="hljs-params">writeStream</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span> (writeStream.__atomicClosed) <span class="hljs-keyword">return</span>
    writeStream.__atomicClosed = <span class="hljs-literal">true</span>
    <span class="hljs-keyword">if</span> (writeStream.__atomicChown) {
      <span class="hljs-keyword">var</span> uid = writeStream.__atomicChown.uid
      <span class="hljs-keyword">var</span> gid = writeStream.__atomicChown.gid
      <span class="hljs-keyword">return</span> fs.chown(writeStream.__atomicTmp, uid, gid, iferr(cleanup, moveIntoPlace))
    } <span class="hljs-keyword">else</span> {
      moveIntoPlace()
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">moveIntoPlace</span> (<span class="hljs-params"></span>) </span>{
    fs.rename(writeStream.__atomicTmp, writeStream.__atomicTarget, iferr(trapWindowsEPERM, end))
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">trapWindowsEPERM</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (writeStream.__isWin &amp;&amp;
        err.syscall &amp;&amp; err.syscall === <span class="hljs-string">'rename'</span> &amp;&amp;
        err.code &amp;&amp; err.code === <span class="hljs-string">'EPERM'</span>
    ) {
      checkFileHashes(err)
    } <span class="hljs-keyword">else</span> {
      cleanup(err)
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">checkFileHashes</span> (<span class="hljs-params">eperm</span>) </span>{
    <span class="hljs-keyword">var</span> inprocess = <span class="hljs-number">2</span>
    <span class="hljs-keyword">var</span> tmpFileHash = crypto.createHash(<span class="hljs-string">'sha512'</span>)
    <span class="hljs-keyword">var</span> targetFileHash = crypto.createHash(<span class="hljs-string">'sha512'</span>)

    fs.createReadStream(writeStream.__atomicTmp)
      .on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, enc</span>) </span>{ tmpFileHash.update(data, enc) })
      .on(<span class="hljs-string">'error'</span>, fileHashError)
      .on(<span class="hljs-string">'end'</span>, fileHashComplete)
    fs.createReadStream(writeStream.__atomicTarget)
      .on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">data, enc</span>) </span>{ targetFileHash.update(data, enc) })
      .on(<span class="hljs-string">'error'</span>, fileHashError)
      .on(<span class="hljs-string">'end'</span>, fileHashComplete)

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fileHashError</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (inprocess === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>
      inprocess = <span class="hljs-number">0</span>
      cleanup(eperm)
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fileHashComplete</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (inprocess === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">if</span> (--inprocess) <span class="hljs-keyword">return</span>
      <span class="hljs-keyword">if</span> (tmpFileHash.digest(<span class="hljs-string">'hex'</span>) === targetFileHash.digest(<span class="hljs-string">'hex'</span>)) {
        <span class="hljs-keyword">return</span> cleanup()
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> cleanup(eperm)
      }
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanup</span> (<span class="hljs-params">err</span>) </span>{
    fs.unlink(writeStream.__atomicTmp, <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (err) {
        writeStream.emit(<span class="hljs-string">'error'</span>, err)
        writeStream.emit(<span class="hljs-string">'close'</span>)
      } <span class="hljs-keyword">else</span> {
        end()
      }
    })
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">end</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>We have to use our parent class directly because we suppress <code>finish</code>
events fired via our own emit method.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    Writable.prototype.emit.call(writeStream, <span class="hljs-string">'finish'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Delay the close to provide the same temporal separation a physical
file operation would have– that is, the close event is emitted only
after the async close operation completes.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    setImmediate(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      writeStream.emit(<span class="hljs-string">'close'</span>)
    })
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">handleError</span> (<span class="hljs-params">writeStream</span>) </span>{
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">er</span>) </span>{
    cleanupSync()
    writeStream.emit(<span class="hljs-string">'error'</span>, er)
    writeStream.__atomicClosed = <span class="hljs-literal">true</span>
    writeStream.emit(<span class="hljs-string">'close'</span>)
  }
  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">cleanupSync</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">try</span> {
      fs.unlinkSync(writeStream.__atomicTmp)
    } <span class="hljs-keyword">finally</span> {
      <span class="hljs-keyword">return</span>
    }
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
