<!DOCTYPE html>
<html>
<head>
  <title>spec.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "ClientApp\\node_modules\\domain-context\\spec.coffee";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>spec.coffee</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="coffeescript">request = <span class="hljs-built_in">require</span> <span class="hljs-string">'supertest'</span>
{equal, ok} = <span class="hljs-built_in">require</span> <span class="hljs-string">'assert'</span>
{run, runInNewDomain, get,
  middleware, middlewareOnError} = <span class="hljs-built_in">require</span> <span class="hljs-string">'./src/index'</span>

describe <span class="hljs-string">'run()'</span>, <span class="hljs-function">-&gt;</span>

  it <span class="hljs-string">'runs a func in an active domain if no domain is provided'</span>, <span class="hljs-function">-&gt;</span>
    domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()
    domain.run -&gt;
      run -&gt;
        equal <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).active, domain
    domain.dispose()

  it <span class="hljs-string">'runs a func in a provided domain'</span>, <span class="hljs-function">-&gt;</span>
    domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()
    anotherDomain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()
    domain.run -&gt;
      run {domain: anotherDomain}, <span class="hljs-function">-&gt;</span>
        equal <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).active, anotherDomain
    domain.dispose()

  it <span class="hljs-string">'allows setting a context with init callback and getting values with get()'</span>, <span class="hljs-function">-&gt;</span>
    domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()
    domain.run -&gt;
      run {context: <span class="hljs-function">-&gt;</span> {a: <span class="hljs-number">1</span>, b: <span class="hljs-number">2</span>}}, <span class="hljs-function">-&gt;</span>
        equal get(<span class="hljs-string">'a'</span>), <span class="hljs-number">1</span>
        equal get(<span class="hljs-string">'b'</span>), <span class="hljs-number">2</span>
        equal get(<span class="hljs-string">'c'</span>), <span class="hljs-literal">undefined</span>
    domain.dispose()

  it <span class="hljs-string">'allows setting the context with set() and getting values with get()'</span>, <span class="hljs-function">-&gt;</span>
    domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()
    domain.run -&gt;
      run {}, <span class="hljs-function">-&gt;</span>
        set(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>)
        equal get(<span class="hljs-string">'foo'</span>), <span class="hljs-string">'bar'</span>
    domain.dispose()

  it <span class="hljs-string">'calls cleanup callback on dispose'</span>, <span class="hljs-function">-&gt;</span>
    cleanupCalled = <span class="hljs-literal">false</span>
    domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()
    domain.run -&gt;
      run {cleanup: <span class="hljs-function">-&gt;</span> cleanupCalled = <span class="hljs-literal">true</span>}, <span class="hljs-function">-&gt;</span>
    domain.dispose()
    ok cleanupCalled

  it <span class="hljs-string">'calls cleanup callback on error if no onError is provided'</span>, <span class="hljs-function">-&gt;</span>
    cleanupCalled = <span class="hljs-literal">false</span>
    domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()
    domain.run -&gt;
      run {cleanup: <span class="hljs-function">-&gt;</span> cleanupCalled = <span class="hljs-literal">true</span>}, <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'x'</span>)
    domain.dispose()
    ok cleanupCalled

  describe <span class="hljs-string">'onError callback'</span>, <span class="hljs-function">-&gt;</span>

    it <span class="hljs-string">'calls onError on sync throw'</span>, <span class="hljs-function">-&gt;</span>

      onErrorCalled = <span class="hljs-literal">false</span>
      domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()
      domain.run -&gt;
        run {onError: <span class="hljs-function">-&gt;</span> onErrorCalled = <span class="hljs-literal">true</span>}, <span class="hljs-function">-&gt;</span>
          <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'x'</span>)
      domain.dispose()
      ok onErrorCalled

    it <span class="hljs-string">'calls onError on async throw'</span>, <span class="hljs-function"><span class="hljs-params">(done)</span> -&gt;</span>
      onErrorCalled = <span class="hljs-literal">false</span>
      domain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()
      domain.run -&gt;
        run {onError: <span class="hljs-function">-&gt;</span> onErrorCalled = <span class="hljs-literal">true</span>}, <span class="hljs-function">-&gt;</span>
          <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).readFile <span class="hljs-string">'non-existent'</span>, <span class="hljs-function"><span class="hljs-params">(err, result)</span> -&gt;</span>
            <span class="hljs-keyword">throw</span> err
      setTimeout (<span class="hljs-function">-&gt;</span>
        ok onErrorCalled
        done()
        ), <span class="hljs-number">20</span>

describe <span class="hljs-string">'runInNewDomain()'</span>, <span class="hljs-function">-&gt;</span>

  it <span class="hljs-string">'runs a func in a new domain'</span>, <span class="hljs-function">-&gt;</span>
    domain = runInNewDomain -&gt;
      equal <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).active, domain
    domain.dispose()

  it <span class="hljs-string">'nestes a new domain to a current one if latter is present'</span>, <span class="hljs-function">-&gt;</span>
    parentDomain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()

    disposed = <span class="hljs-literal">false</span>
    errorCalled = <span class="hljs-literal">false</span>

    parentDomain.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function">-&gt;</span>
      errorCalled = <span class="hljs-literal">true</span>

    parentDomain.run -&gt;
      domain = runInNewDomain -&gt;
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'x'</span>)
      domain.<span class="hljs-literal">on</span> <span class="hljs-string">'dispose'</span>, <span class="hljs-function">-&gt;</span>
        disposed = <span class="hljs-literal">true</span>
      ok errorCalled
    parentDomain.dispose()
    ok disposed

  it <span class="hljs-string">'does not nest domain if detach option is provided'</span>, <span class="hljs-function">-&gt;</span>
    parentDomain = <span class="hljs-built_in">require</span>(<span class="hljs-string">'domain'</span>).create()

    disposed = <span class="hljs-literal">false</span>
    errorCalled = <span class="hljs-literal">false</span>

    parentDomain.<span class="hljs-literal">on</span> <span class="hljs-string">'error'</span>, <span class="hljs-function">-&gt;</span>
      errorCalled = <span class="hljs-literal">true</span>

    parentDomain.run -&gt;
      domain = runInNewDomain {detach: <span class="hljs-literal">true</span>}, <span class="hljs-function">-&gt;</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'x'</span>)
      domain.<span class="hljs-literal">on</span> <span class="hljs-string">'dispose'</span>, <span class="hljs-function">-&gt;</span>
        disposed = <span class="hljs-literal">true</span>
      ok <span class="hljs-keyword">not</span> errorCalled
    parentDomain.dispose()
    ok <span class="hljs-keyword">not</span> disposed

describe <span class="hljs-string">'middleware()'</span>, <span class="hljs-function">-&gt;</span>

  connectDomain = <span class="hljs-built_in">require</span> <span class="hljs-string">'connect-domain'</span>
  connect = <span class="hljs-built_in">require</span> <span class="hljs-string">'connect'</span>
<span class="hljs-function">  <span class="hljs-title">configureApp</span> = <span class="hljs-params">(options)</span> -&gt;</span>
    app = connect()
    app.use connectDomain()
    app.use middleware(options)
    app.use options.handler
    app.use middlewareOnError(options)
    app

  it <span class="hljs-string">'allows getting values out of context with get()'</span>, <span class="hljs-function"><span class="hljs-params">(done)</span> -&gt;</span>
    value = <span class="hljs-literal">undefined</span>
    app = configureApp
      context: <span class="hljs-function">-&gt;</span> value: <span class="hljs-string">'x'</span>
      handler: <span class="hljs-function"><span class="hljs-params">(req, res)</span> -&gt;</span>
        value = get(<span class="hljs-string">'value'</span>)
        res.write(<span class="hljs-string">'ok'</span>)
        res.end()
    request(app)
      .get(<span class="hljs-string">'/'</span>)
      .expect <span class="hljs-number">200</span>, <span class="hljs-function">-&gt;</span>
        equal value, <span class="hljs-string">'x'</span>
        done()

  it <span class="hljs-string">'calls cleanup on finish request'</span>, <span class="hljs-function"><span class="hljs-params">(done)</span> -&gt;</span>
    cleanupCalled = <span class="hljs-literal">false</span>
    app = configureApp
      cleanup: <span class="hljs-function">-&gt;</span> cleanupCalled = <span class="hljs-literal">true</span>
      handler: <span class="hljs-function"><span class="hljs-params">(req, res)</span> -&gt;</span>
        res.write(<span class="hljs-string">'ok'</span>)
        res.end()
    request(app)
      .get(<span class="hljs-string">'/'</span>)
      .expect <span class="hljs-number">200</span>, <span class="hljs-function">-&gt;</span>
        ok cleanupCalled
        done()

  it <span class="hljs-string">'calls onError sync throw'</span>, <span class="hljs-function"><span class="hljs-params">(done)</span> -&gt;</span>
    onErrorCalled = <span class="hljs-literal">false</span>
    app = configureApp
      onError: <span class="hljs-function">-&gt;</span> onErrorCalled = <span class="hljs-literal">true</span>
      handler: <span class="hljs-function"><span class="hljs-params">(req, res)</span> -&gt;</span>
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> Error(<span class="hljs-string">'x'</span>)
    request(app)
      .get(<span class="hljs-string">'/'</span>)
      .expect <span class="hljs-number">500</span>, <span class="hljs-function">-&gt;</span>
        ok onErrorCalled 
        done()

  it <span class="hljs-string">'calls onError on next(err) call'</span>, <span class="hljs-function"><span class="hljs-params">(done)</span> -&gt;</span>
    onErrorCalled = <span class="hljs-literal">false</span>
    app = configureApp
      onError: <span class="hljs-function">-&gt;</span> onErrorCalled = <span class="hljs-literal">true</span>
      handler: <span class="hljs-function"><span class="hljs-params">(req, res, next)</span> -&gt;</span>
        next(<span class="hljs-keyword">new</span> Error(<span class="hljs-string">'x'</span>))
    request(app)
      .get(<span class="hljs-string">'/'</span>)
      .expect <span class="hljs-number">500</span>, <span class="hljs-function">-&gt;</span>
        ok onErrorCalled 
        done()

  it <span class="hljs-string">'calls onError on async throw'</span>, <span class="hljs-function"><span class="hljs-params">(done)</span> -&gt;</span>
    onErrorCalled = <span class="hljs-literal">false</span>
    app = configureApp
      onError: <span class="hljs-function">-&gt;</span> onErrorCalled = <span class="hljs-literal">true</span>
      handler: <span class="hljs-function"><span class="hljs-params">(req, res, next)</span> -&gt;</span>
        <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>).readFile <span class="hljs-string">'non-existent'</span>, <span class="hljs-function"><span class="hljs-params">(err)</span> -&gt;</span>
          <span class="hljs-keyword">throw</span> err
    request(app)
      .get(<span class="hljs-string">'/'</span>)
      .expect <span class="hljs-number">500</span>, <span class="hljs-function">-&gt;</span>
        ok onErrorCalled 
        done()

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
