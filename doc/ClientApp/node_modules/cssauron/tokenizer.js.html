<!DOCTYPE html>
<html>
<head>
  <title>tokenizer.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../../doc-style.css" />
  <script src="../../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../../";
    var thisFile = "ClientApp\\node_modules\\cssauron\\tokenizer.js";
    var defaultSidebar = true;
  </script>
  <script src="../../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>tokenizer.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-built_in">module</span>.exports = tokenize

<span class="hljs-keyword">var</span> through = <span class="hljs-built_in">require</span>(<span class="hljs-string">'through'</span>)

<span class="hljs-keyword">var</span> PSEUDOSTART = <span class="hljs-string">'pseudo-start'</span>
  , ATTR_START = <span class="hljs-string">'attr-start'</span>
  , ANY_CHILD = <span class="hljs-string">'any-child'</span>
  , ATTR_COMP = <span class="hljs-string">'attr-comp'</span>
  , ATTR_END = <span class="hljs-string">'attr-end'</span>
  , PSEUDOPSEUDO = <span class="hljs-string">'::'</span>
  , PSEUDOCLASS = <span class="hljs-string">':'</span>
  , READY = <span class="hljs-string">'(ready)'</span>
  , OPERATION = <span class="hljs-string">'op'</span>
  , CLASS = <span class="hljs-string">'class'</span>
  , COMMA = <span class="hljs-string">'comma'</span>
  , ATTR = <span class="hljs-string">'attr'</span>
  , SUBJECT = <span class="hljs-string">'!'</span>
  , TAG = <span class="hljs-string">'tag'</span>
  , STAR = <span class="hljs-string">'*'</span>
  , ID = <span class="hljs-string">'id'</span>

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">tokenize</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> escaped = <span class="hljs-literal">false</span>
    , gathered = []
    , state = READY 
    , data = []
    , idx = <span class="hljs-number">0</span>
    , stream
    , length
    , quote
    , depth
    , lhs
    , rhs
    , cmp
    , c

  <span class="hljs-keyword">return</span> stream = through(ondata, onend)

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ondata</span>(<span class="hljs-params">chunk</span>) </span>{
    data = data.concat(chunk.split(<span class="hljs-string">''</span>))
    length = data.length

    <span class="hljs-keyword">while</span>(idx &lt; length &amp;&amp; (c = data[idx++])) {
      <span class="hljs-keyword">switch</span>(state) {
        <span class="hljs-keyword">case</span> READY: state_ready(); <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> ANY_CHILD: state_any_child(); <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> OPERATION: state_op(); <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> ATTR_START: state_attr_start(); <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> ATTR_COMP: state_attr_compare(); <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> ATTR_END: state_attr_end(); <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> PSEUDOCLASS:
        <span class="hljs-keyword">case</span> PSEUDOPSEUDO: state_pseudo(); <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> PSEUDOSTART: state_pseudostart(); <span class="hljs-keyword">break</span>
        <span class="hljs-keyword">case</span> ID:
        <span class="hljs-keyword">case</span> TAG:
        <span class="hljs-keyword">case</span> CLASS: state_gather(); <span class="hljs-keyword">break</span>
      }
    }

    data = data.slice(idx)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onend</span>(<span class="hljs-params">chunk</span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-built_in">arguments</span>.length) {
      ondata(chunk)
    }

    <span class="hljs-keyword">if</span>(gathered.length) {
      stream.queue(token())
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">state_ready</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">switch</span>(<span class="hljs-literal">true</span>) {
      <span class="hljs-keyword">case</span> <span class="hljs-string">'#'</span> === c: state = ID; <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'.'</span> === c: state = CLASS; <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">':'</span> === c: state = PSEUDOCLASS; <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'['</span> === c: state = ATTR_START; <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'!'</span> === c: subject(); <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">'*'</span> === c: star(); <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-string">','</span> === c: comma(); <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-regexp">/[&gt;\+~]/</span>.test(c): state = OPERATION; <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-regexp">/\s/</span>.test(c): state = ANY_CHILD; <span class="hljs-keyword">break</span>
      <span class="hljs-keyword">case</span> <span class="hljs-regexp">/[\w\d\-_]/</span>.test(c): state = TAG; --idx; <span class="hljs-keyword">break</span>
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">subject</span>(<span class="hljs-params"></span>) </span>{
    state = SUBJECT
    gathered = [<span class="hljs-string">'!'</span>]
    stream.queue(token())
    state = READY
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">star</span>(<span class="hljs-params"></span>) </span>{
    state = STAR
    gathered = [<span class="hljs-string">'*'</span>]
    stream.queue(token())
    state = READY
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">comma</span>(<span class="hljs-params"></span>) </span>{
    state = COMMA
    gathered = [<span class="hljs-string">','</span>]
    stream.queue(token())
    state = READY
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">state_op</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/[&gt;\+~]/</span>.test(c)) {
      <span class="hljs-keyword">return</span> gathered.push(c)
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>chomp down the following whitespace.</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/\s/</span>.test(c)) {
      <span class="hljs-keyword">return</span>
    }

    stream.queue(token())
    state = READY
    --idx
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">state_any_child</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/\s/</span>.test(c)) {
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/[&gt;\+~]/</span>.test(c)) {
      <span class="hljs-keyword">return</span> --idx, state = OPERATION
    }

    stream.queue(token())
    state = READY
    --idx
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">state_pseudo</span>(<span class="hljs-params"></span>) </span>{
    rhs = state
    state_gather(<span class="hljs-literal">true</span>)

    <span class="hljs-keyword">if</span>(state !== READY) {
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span>(c === <span class="hljs-string">'('</span>) {
      lhs = gathered.join(<span class="hljs-string">''</span>)
      state = PSEUDOSTART
      gathered.length = <span class="hljs-number">0</span>
      depth = <span class="hljs-number">1</span>
      ++idx

      <span class="hljs-keyword">return</span>
    }

    state = PSEUDOCLASS
    stream.queue(token())
    state = READY
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">state_pseudostart</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(gathered.length === <span class="hljs-number">0</span> &amp;&amp; !quote) {
      quote = <span class="hljs-regexp">/['"]/</span>.test(c) ? c : <span class="hljs-literal">null</span>

      <span class="hljs-keyword">if</span>(quote) {
        <span class="hljs-keyword">return</span>
      }
    }

    <span class="hljs-keyword">if</span>(quote) {
      <span class="hljs-keyword">if</span>(!escaped &amp;&amp; c === quote) {
        quote = <span class="hljs-literal">null</span>

        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-keyword">if</span>(c === <span class="hljs-string">'\\'</span>) {
        escaped ? gathered.push(c) : (escaped = <span class="hljs-literal">true</span>)

        <span class="hljs-keyword">return</span>
      }

      escaped = <span class="hljs-literal">false</span>
      gathered.push(c)

      <span class="hljs-keyword">return</span>
    }

    gathered.push(c)

    <span class="hljs-keyword">if</span>(c === <span class="hljs-string">'('</span>) {
      ++depth
    } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(c === <span class="hljs-string">')'</span>) {
      --depth
    }
    
    <span class="hljs-keyword">if</span>(!depth) {
      gathered.pop()
      stream.queue({
          <span class="hljs-attr">type</span>: rhs 
        , <span class="hljs-attr">data</span>: lhs + <span class="hljs-string">'('</span> + gathered.join(<span class="hljs-string">''</span>) + <span class="hljs-string">')'</span>
      })

      state = READY
      lhs = rhs = cmp = <span class="hljs-literal">null</span>
      gathered.length = <span class="hljs-number">0</span>
    }

    <span class="hljs-keyword">return</span> 
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">state_attr_start</span>(<span class="hljs-params"></span>) </span>{
    state_gather(<span class="hljs-literal">true</span>)

    <span class="hljs-keyword">if</span>(state !== READY) {
      <span class="hljs-keyword">return</span>
    }

    <span class="hljs-keyword">if</span>(c === <span class="hljs-string">']'</span>) {
      state = ATTR
      stream.queue(token())
      state = READY

      <span class="hljs-keyword">return</span>
    }

    lhs = gathered.join(<span class="hljs-string">''</span>)
    gathered.length = <span class="hljs-number">0</span>
    state = ATTR_COMP
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">state_attr_compare</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/[=~|$^*]/</span>.test(c)) {
      gathered.push(c)
    }

    <span class="hljs-keyword">if</span>(gathered.length === <span class="hljs-number">2</span> || c === <span class="hljs-string">'='</span>) {
      cmp = gathered.join(<span class="hljs-string">''</span>)
      gathered.length = <span class="hljs-number">0</span>
      state = ATTR_END
      quote = <span class="hljs-literal">null</span>

      <span class="hljs-keyword">return</span>
    }
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">state_attr_end</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">if</span>(!gathered.length &amp;&amp; !quote) {
      quote = <span class="hljs-regexp">/['"]/</span>.test(c) ? c : <span class="hljs-literal">null</span>

      <span class="hljs-keyword">if</span>(quote) {
        <span class="hljs-keyword">return</span>
      }
    }

    <span class="hljs-keyword">if</span>(quote) {
      <span class="hljs-keyword">if</span>(!escaped &amp;&amp; c === quote) {
        quote = <span class="hljs-literal">null</span>

        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-keyword">if</span>(c === <span class="hljs-string">'\\'</span>) {
        <span class="hljs-keyword">if</span>(escaped) {
          gathered.push(c)
        }

        escaped = !escaped

        <span class="hljs-keyword">return</span>
      }

      escaped = <span class="hljs-literal">false</span>
      gathered.push(c)

      <span class="hljs-keyword">return</span>
    }

    state_gather(<span class="hljs-literal">true</span>)

    <span class="hljs-keyword">if</span>(state !== READY) {
      <span class="hljs-keyword">return</span>
    }

    stream.queue({
        <span class="hljs-attr">type</span>: ATTR
      , <span class="hljs-attr">data</span>: {
            <span class="hljs-attr">lhs</span>: lhs
          , <span class="hljs-attr">rhs</span>: gathered.join(<span class="hljs-string">''</span>)
          , <span class="hljs-attr">cmp</span>: cmp
        }
    })

    state = READY
    lhs = rhs = cmp = <span class="hljs-literal">null</span>
    gathered.length = <span class="hljs-number">0</span>

    <span class="hljs-keyword">return</span> 
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">state_gather</span>(<span class="hljs-params">quietly</span>) </span>{
    <span class="hljs-keyword">if</span>(<span class="hljs-regexp">/[^\d\w\-_]/</span>.test(c) &amp;&amp; !escaped) {
      <span class="hljs-keyword">if</span>(c === <span class="hljs-string">'\\'</span>) {
        escaped = <span class="hljs-literal">true</span>
      } <span class="hljs-keyword">else</span> {
        !quietly &amp;&amp; stream.queue(token())
        state = READY
        --idx
      }

      <span class="hljs-keyword">return</span>
    }

    escaped = <span class="hljs-literal">false</span>
    gathered.push(c)
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">token</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> data = gathered.join(<span class="hljs-string">''</span>)

    gathered.length = <span class="hljs-number">0</span>

    <span class="hljs-keyword">return</span> {
        <span class="hljs-attr">type</span>: state
      , <span class="hljs-attr">data</span>: data
    }
  }
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
